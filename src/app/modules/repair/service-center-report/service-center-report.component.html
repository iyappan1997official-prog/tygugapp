<!---<div class="content-wrapper">

   <div class="card p-4 cardheight" [formGroup]="serviceCenterForm">

    
    <div fxLayout="row" fxLayoutAlign="start center">
      <h2 class="mb-0 main-color font-w-600 fs-24">
        <img class="cursor mb-1 doNotPrint"
             src="../../../../assets/logos/arrow-backP.svg"
             routerLink="/repair/repair-reports">
        &nbsp;Service Center Report
      </h2>
    </div>

    
    <div fxLayout="row"
         fxLayout.lt-md="column"
         fxLayoutAlign="space-between center"
         class="mt-3 doNotPrint">

      <div fxLayout="row"
           fxLayoutGap="10px"
           fxLayout.lt-md="column"
           fxLayoutAlign="start center"
           class="w-100">

        <mat-form-field appearance="outline" class="input-pdt fs-16 searchBox">
          <mat-icon matPrefix class="sub-prefix">search</mat-icon>
          <mat-select placeholder="Service Center Location"
                      class="w-100 form-control p-0"
                      style="border:none;"
                      formControlName="locationId">
            <mat-option value="0">All</mat-option>
            <ng-container *ngFor="let location of serviceCenterLocations">
              <mat-option [value]="location.id">
                {{location.name}}
              </mat-option>
            </ng-container>
          </mat-select>
        </mat-form-field>

      </div>

      <div fxLayout="row"
           fxLayoutAlign="space-between center"
           fxLayoutGap="20px"
           class="border-left ps-3">

        <button class="btn btn-newPrimary btncolor p-12 mb-xl-0 mb-3"
                (click)="searchReport()">
          Search
        </button>

        <button class="btn btnborder p-12 mb-xl-0 mb-3"
                (click)="resetReport()">
          Reset
        </button>

        <button class="btn btn-newPrimary p-12 text-white btncolor">
          Print
        </button>

      </div>
    </div>

    
    <div fxLayout="row"
         fxLayoutGap="20px"
         fxLayoutAlign="center"
         class="my-3 align-items-center">

      <div class="card sub-card text-center p-3">
        <div class="mb-1 text-color">Total Quilts </div>
        <div class="font-w-600 text-color">{{usageData?.totalquilts || 0}}</div>
      </div>

      <div class="card sub-card text-center p-3">
        <div class="mb-1 text-color">Cleaned</div>
        <div class="font-w-600 text-color">{{usageData?.cleaning || 0}}</div>
      </div>

      <div class="card sub-card text-center p-3">
        <div class="mb-1 text-color">Repaired</div>
        <div class="font-w-600 text-color">{{usageData?.repairing || 0}}</div>
      </div>

      <div class="card sub-card text-center p-3">
        <div class="mb-1 text-color">Retired</div>
        <div class="font-w-600 text-color">{{usageData?.retired || 0}}</div>
      </div>

      <div class="date-export-row">

        <button class="btn btnborder p-12">
                (click)="exportReport()"
          Export
        </button>

      </div>

    </div>

   
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr class="tablelight text-center">
            <th>Location</th>
            <th>Total Returned</th>
            <th>Cleaned </th>
            <th>Repaired</th>
            <th>Retired</th>

          </tr>
        </thead>

        <tbody>
          <ng-container *ngIf="items$ | async as dataList">
            <ng-container *ngFor="let data of dataList; let i = index">

              <tr class="text-center">
                <td class="cursor" (click)="toggleRow(i)">
                  {{ data.location }}
                </td>
                <td>{{data.totalReturned }}</td>
                <td>{{ data.cleaningCount }}</td>
                <td>{{ data.repairingCount }}</td>
                <td>{{ data.retringCount }}</td>
              </tr>

              
              <tr *ngIf="expandedIndex === i">
                <td colspan="7">
                  <table class="table w-100">
                    <thead>
                      <tr class="text-center">
                        <th>PartNumber</th>
                        <th>Total Returned</th>
                        <th>Cleaned</th>
                        <th>Repaired</th>
                        <th>Retired</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr class="text-center"
                          *ngFor="let sub of data.quiltsUsageCustomer">
                        <td>{{ sub.partNumber }}</td>
                        <td>{{data.totalReturned }}</td>
                        <td>{{ sub.cleaningCount }}</td>
                        <td>{{ sub.repairingCount }}</td>
                        <td>{{ sub.retringCount }}</td>
                      </tr>
                    </tbody>
                  </table>
                </td>
              </tr>

            </ng-container>
          </ng-container>
        </tbody>
      </table>
    </div>

     
    <mat-paginator [length]="length"
                   [pageSize]="pageSize"
                   [pageSizeOptions]="pageSizeOptions"
                   (page)="paginator($event)"
                   showFirstLastButtons>
    </mat-paginator>

  </div>
</div> -->
<div class="content-wrapper">
  <div class="card p-4 cardheight" [formGroup]="serviceCenterForm">
    <div fxLayout="row" fxLayoutAlign="start center">
      <h2 class="mb-0 main-color font-w-600 fs-24">
        <img class="cursor mb-1 doNotPrint"
             src="../../../../assets/logos/arrow-backP.svg"
             routerLink="/repair/repair-reports">
        &nbsp;Service Center Report
      </h2>
    </div>


    <div fxLayout="row"
         fxLayout.lt-md="column"
         fxLayoutAlign="space-between center"
         class="mt-3">

      <div fxLayout="row"
           fxLayoutGap="10px"
           fxLayout.lt-md="column"
           fxLayoutAlign="start center"
           class="w-100">

        <mat-form-field appearance="outline" class="input-pdt fs-16 searchBox">
          <mat-icon matPrefix class="sub-prefix">search</mat-icon>
          <mat-select placeholder="Service Center Location"
                      class="w-100 form-control p-0"
                      style="border:none;"
                      formControlName="locationId">
            <mat-option value="0">All</mat-option>
            <ng-container *ngFor="let location of serviceCenterLocations">
              <mat-option [value]="location.id">
                {{location.name}}
              </mat-option>
            </ng-container>
          </mat-select>
        </mat-form-field>
        <div *ngIf="dateRangeDisplay" class="report-date-text">
          {{ dateRangeDisplay }}
        </div>

      </div>

      <div fxLayout="row"
           fxLayoutAlign="space-between center"
           fxLayoutGap="10px"
           class="border-left ps-3">

        <button class="btn btn-newPrimary btncolor p-12 mb-xl-0 mb-3"
                style="min-width: 120px;"
                [disabled]="isLoading"
                (click)="searchReport()">
          Search
        </button>

        <button class="btn btnborder p-12 mb-xl-0 mb-3"
                style="min-width: 120px;"
                [disabled]="isLoading"
                (click)="resetReport()">
          Reset
        </button>

        <button class="btn btn-success btn-color-green p-12 mb-xl-0 mb-3"
                style="min-width: 120px;"
                [disabled]="isLoading"
                (click)="syncLatestData()">
          Sync
        </button>

        <button class="btn btn-newPrimary p-12 text-white btncolor"
                style="min-width: 120px;"
                [disabled]="isLoading"
                (click)="preparePrintData()"
                [useExistingCss]="true"
                printSectionId="serviceCenterPrintSection"
                ngxPrint>
          Print
        </button>

      </div>
    </div>


    <div fxLayout="row" fxLayoutAlign="end center" fxLayoutGap="8px" class="mt-2 doNotPrint">
      <mat-form-field appearance="outline" class="input-pdt fs-16" style="min-width: 220px; margin-bottom: 0;">
        <mat-select placeholder="Select export type"
                    [(value)]="selectedExportType">
          <mat-option value="hierarchical">Hierarchical</mat-option>
          <mat-option value="raw">Linear Flat</mat-option>
        </mat-select>
      </mat-form-field>
      <button class="btn btnborder p-12"
              style="min-width: 120px; height: 56px;"
              [disabled]="isLoading"
              (click)="exportSelectedReport()">
        Export
      </button>
    </div>
    <div fxLayout="row" fxLayoutAlign="end center"
         class="text-danger fs-12 mt-1 doNotPrint"
         *ngIf="exportTypeTouched && !selectedExportType">
      Please select export type before exporting.
    </div>

    <div fxLayout="row" fxLayoutAlign="start center" class="my-3 w-100">

      <!-- LEFT EMPTY FLEX (balances center) -->
      <div fxFlex></div>

      <!-- CENTER CARDS GROUP -->
      <div fxLayout="row"
           fxLayoutGap="16px"
           fxLayoutAlign="center center"
           class="cards-wrapper">

        <div class="card sub-card text-center p-3">
          <div class="mb-1 text-color">Total Quilts</div>
          <div class="font-w-600 text-color">{{usageData?.totalquilts || 0}}</div>
        </div>

        <div class="card sub-card text-center p-3">
          <div class="mb-1 text-color">Total Returned</div>
          <div class="font-w-600 text-color">{{usageData?.grandtotalreturned || 0}}</div>
        </div>

        <div class="card sub-card text-center p-3">
          <div class="mb-1 text-color">Cleaned</div>
          <div class="font-w-600 text-color">{{usageData?.cleaning || 0}}</div>
        </div>

        <div class="card sub-card text-center p-3">
          <div class="mb-1 text-color">Repaired</div>
          <div class="font-w-600 text-color">{{usageData?.repairing || 0}}</div>
        </div>

        <div class="card sub-card text-center p-3">
          <div class="mb-1 text-color">Retired</div>
          <div class="font-w-600 text-color">{{usageData?.retired || 0}}</div>
        </div>

      </div>

      <div fxFlex></div>

    </div>
    <app-loader *ngIf="isLoading"></app-loader>

    <div class="table-responsive mt-3">
      <table class="table repair-summary-table">
        <colgroup>
          <col style="width: 18%">
          <col style="width: 18%">
          <col style="width: 18%">
          <col style="width: 18%">
          <col style="width: 18%">
        </colgroup>
        <thead>
          <tr class="tablelight text-center">
            <th class="hierarchy-header cursor" (click)="sortTopLevel('location')">
              <span class="header-spacer"></span>
              <span class="sort-header-label">
                Location
                <i class="fa fa-sort ms-2" aria-hidden="true"></i>
              </span>
            </th>
            <th class="cursor" (click)="sortTopLevel('totalReturned')">
              <span class="sort-header-label">
                Total Returned
                <i class="fa fa-sort ms-2" aria-hidden="true"></i>
              </span>
            </th>
            <th class="cursor" (click)="sortTopLevel('cleaningCount')">
              <span class="sort-header-label">
                Cleaned
                <i class="fa fa-sort ms-2" aria-hidden="true"></i>
              </span>
            </th>
            <th class="cursor" (click)="sortTopLevel('repairingCount')">
              <span class="sort-header-label">
                Repaired
                <i class="fa fa-sort ms-2" aria-hidden="true"></i>
              </span>
            </th>
            <th class="cursor" (click)="sortTopLevel('retringCount')">
              <span class="sort-header-label">
                Retired
                <i class="fa fa-sort ms-2" aria-hidden="true"></i>
              </span>
            </th>
          </tr>
        </thead>

        <tbody>
          <ng-container *ngIf="items$ | async as dataList">

            <ng-container *ngFor="let data of dataList; let i = index">

              <!-- ================= LOCATION ================= -->
              <tr class="text-center">
                <td class="hierarchy-cell">
                  <div class="arrow-box" (click)="toggleRow(i)">
                    <img class="arrow-icon"
                         [src]="expandedIndex === i
                       ? '../../../../assets/logos/downarrowS.svg'
                       : '../../../../assets/logos/rightarrowS.svg'">
                  </div>
                  <div class="row-label">{{ data.location }}</div>
                </td>

                <td>{{ data.totalReturned }}</td>
                <td>{{ data.cleaningCount }}</td>
                <td>{{ data.repairingCount }}</td>
                <td>{{ data.retringCount }}</td>
              </tr>

              <!-- ================= PART TABLE ================= -->
              <tr *ngIf="expandedIndex === i">
                <td colspan="5" class="border-0 p-0">

                  <div class="part-wrapper">
                    <table class="table part-number-table">
                      <colgroup>
                        <col style="width: 17%">
                        <col style="width: 18%">
                        <col style="width: 18%">
                        <col style="width: 18%">
                        <col style="width: 18%">
                      </colgroup>
                      <thead>
                        <tr class="text-center">
                          <th class="hierarchy-header">
                            <span class="header-spacer"></span>
                            Part Number
                          </th>
                          <th>Total Returned</th>
                          <th>Cleaned</th>
                          <th>Repaired</th>
                          <th>Retired</th>
                        </tr>
                      </thead>

                      <tbody>

                        <ng-container *ngFor="let sub of data.quiltsUsageCustomer; let j = index">

                          <!-- PART ROW -->
                          <tr class="text-center">
                            <td class="hierarchy-cell">
                              <div class="arrow-box" (click)="togglePartDetails(i,j)">
                                <img class="arrow-icon"
                                     [src]="isPartExpanded(i,j)
                                   ? '../../../../assets/logos/downarrowS.svg'
                                   : '../../../../assets/logos/rightarrowS.svg'">
                              </div>
                              <div class="row-label">{{ sub.partNumber }}</div>
                            </td>

                            <td>{{ sub.totalReturned }}</td>
                            <td>{{ sub.cleaningCount }}</td>
                            <td>{{ sub.repairingCount }}</td>
                            <td>{{ sub.retringCount }}</td>
                          </tr>

                          <!-- ================= QUILT TABLE ================= -->
                          <tr *ngIf="isPartExpanded(i,j)">
                            <td colspan="5" class="border-0 p-0">

                              <div class="quilt-wrapper">
                                <table class="table quilt-table">
                                  <colgroup>
                                    <col style="width: 14%">
                                    <col style="width: 12%">
                                    <col style="width: 12%">
                                    <col style="width: 12%">
                                    <col style="width: 12%">
                                    <col style="width: 38%">
                                  </colgroup>
                                  <thead>
                                    <tr class="text-center">
                                      <th class="hierarchy-header">
                                        <span class="header-spacer"></span>
                                        Serial Number
                                      </th>
                                      <th>Total Returned</th>
                                      <th>Cleaned</th>
                                      <th>Repaired</th>
                                      <th>Retired</th>
                                      <th>Repair Type Aggregates</th>
                                    </tr>
                                  </thead>

                                  <tbody>
                                    <ng-container *ngFor="let quilt of sub.quilts; let k = index">
                                      <tr class="text-center">
                                        <td class="hierarchy-cell">
                                          <div class="arrow-box"
                                               *ngIf="hasQuiltChildren(quilt)"
                                               (click)="toggleQuiltDetails(i,j,k)">
                                            <img class="arrow-icon"
                                                 [src]="isQuiltExpanded(i,j,k)
             ? '../../../../assets/logos/downarrowS.svg'
             : '../../../../assets/logos/rightarrowS.svg'">
                                          </div>
                                          <div class="arrow-box" *ngIf="!hasQuiltChildren(quilt)"></div>
                                          <div class="row-label">
                                            {{ quilt.serialNumber }}
                                          </div>
                                        </td>

                                        <td>{{ quilt.returned }}</td>
                                        <td>{{ quilt.cleaned }}</td>
                                        <td>{{ quilt.repaired }}</td>
                                        <td>{{ quilt.retired }}</td>
                                        <td class="text-start">{{ quilt.repairTypes || '' }}</td>
                                      </tr>
                                      <tr *ngIf="isQuiltExpanded(i,j,k) && hasQuiltChildren(quilt)">
                                        <td colspan="6" class="border-0 p-0">
                                          <div class="cycle-wrapper">
                                            <table class="table quilt-table cycle-table">
                                              <colgroup>
                                                <col style="width: 14%">
                                                <col style="width: 12%">
                                                <col style="width: 10%">
                                                <col style="width: 10%">
                                                <col style="width: 10%">
                                                <col style="width: 10%">
                                                <col style="width: 34%">
                                              </colgroup>
                                              <thead>
                                                <tr class="text-center">
                                                  <th>ICR Cycle</th>
                                                  <th>Status</th>
                                                  <th>Returned</th>
                                                  <th>Cleaned</th>
                                                  <th>Repaired</th>
                                                  <th>Retired</th>
                                                  <th class="repair-agg-col">Repair Type Aggregates</th>
                                                </tr>
                                              </thead>
                                              <tbody>
                                                <tr class="text-center" *ngFor="let cycle of quilt.cycles">
                                                  <td>{{ formatIcrCycle(cycle.icrCycle) }}</td>
                                                  <td>{{ cycle.status }}</td>
                                                  <td>{{ cycle.returned }}</td>
                                                  <td>{{ cycle.cleaned }}</td>
                                                  <td>{{ cycle.repaired }}</td>
                                                  <td>{{ cycle.retired }}</td>
                                                  <td class="repair-agg-col">{{ cycle.repairTypes || '' }}</td>
                                                </tr>
                                              </tbody>
                                            </table>
                                          </div>
                                        </td>
                                      </tr>
                                    </ng-container>
                                  </tbody>

                                </table>
                              </div>

                            </td>
                          </tr>

                        </ng-container>

                      </tbody>

                    </table>
                  </div>

                </td>
              </tr>

            </ng-container>

          </ng-container>
        </tbody>

      </table>
    </div>

    <mat-paginator [length]="length"
                   [pageSize]="pageSize"
                   [pageSizeOptions]="pageSizeOptions"
                   (page)="paginator($event)"
                   showFirstLastButtons>
    </mat-paginator>
  </div>
</div>

<div id="serviceCenterPrintSection" class="print-only">
  <h2 class="print-title">Service Center Report</h2>
  <div *ngIf="dateRangeDisplay" class="print-date">{{ dateRangeDisplay }}</div>

  <table class="print-table">
    <thead>
      <tr>
        <th>Location</th>
        <th>Part Number</th>
        <th>Serial Number</th>
        <th>ICR Cycle</th>
        <th>Status</th>
        <th>Returned</th>
        <th>Cleaned</th>
        <th>Repaired</th>
        <th>Retired</th>
        <th>Repair Type Aggregates</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let row of printRows">
        <td>{{ row.locationName }}</td>
        <td>{{ row.partNumber }}</td>
        <td>{{ row.serialNumber }}</td>
        <td>{{ formatIcrCycle(row.icrCycle) }}</td>
        <td>{{ row.status || '-' }}</td>
        <td>{{ row.returned }}</td>
        <td>{{ row.cleaned }}</td>
        <td>{{ row.repaired }}</td>
        <td>{{ row.retired }}</td>
        <td>{{ row.repairTypes }}</td>
      </tr>
    </tbody>
  </table>
</div>
